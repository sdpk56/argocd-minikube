name: Install ArgoCD on Minikube

on:
  workflow_dispatch:

jobs:
  install-argocd:
    runs-on: [self-hosted, linux]  # ARC runner inside Minikube

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Create argocd namespace
        run: |
          kubectl create namespace argocd || echo "Namespace exists"

      - name: Install ArgoCD
        run: |
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

      - name: Wait for ArgoCD server to be ready
        run: |
          kubectl wait --for=condition=available --timeout=180s deployment/argocd-server -n argocd

      - name: Patch ArgoCD server service to NodePort
        run: |
          kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "NodePort"}}'

      - name: Show ArgoCD Initial Access Info
        run: |
          echo "üîê ArgoCD Login Credentials:"
          echo "----------------------------------"
          echo "üë§ Username: admin"
          echo -n "üîë Password: "
          kubectl -n argocd get secret argocd-initial-admin-secret \
            -o jsonpath="{.data.password}" | base64 -d; echo
          echo "----------------------------------"

          echo "üåê Access URL:"
          minikube service argocd-server -n argocd --url
